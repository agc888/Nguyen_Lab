---
title: "Metabolics"
output: html_document
date: "2023-08-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r remove_data, include=FALSE}

#removes all data from global environment
rm(list = ls())
```

```{r librarys}
library(Cardinal)
library(cowplot)

```

## Read data

```{r Read_data}
DATA_DIR <- "I:/CMM1636-Q5291/VLP94_MALDI/2023.09.11 imzML file/"
OUT_DIR <- "I:/GML001-Q1851/Andrew_C/Metabolomics/"

treatment_1 <- readMSIData(paste0(DATA_DIR,"vlp94c-treated-dhb.imzML"),mass.range = c(160,3000),resolution = 300, attach.only = TRUE)
control_1 <- readMSIData(paste0(DATA_DIR,"vlp94a-control-dhb.imzML"),mass.range = c(160,3000), resolution = 300, attach.only = TRUE)
treatment_2 <- readMSIData(paste0(DATA_DIR,"vlp94d-treated-dhb.imzML"),mass.range = c(160,3000), resolution = 260, attach.only = TRUE)
control_2 <- readMSIData(paste0(DATA_DIR,"vlp94b-control-dhb.imzML"),mass.range = c(160,3000), resolution = 260, attach.only = TRUE)
```



### Combine samples into treatment and control for run 1 and 2
```{r combine_runs}
set_centroid_to_true <- function(data){
  centroided(data) <- TRUE
  return(data)
}

treatment_1 <- set_centroid_to_true(treatment_1)
control_1 <- set_centroid_to_true(control_1)

### shift the coords of the treated sample so it doesnt overlap with the control sample image
treatment_1_add <- treatment_1
treatment_1_add_pixel_data <- pixelData(treatment_1_add)
treatment_1_add_pixel_data@coord$x <- treatment_1_add_pixel_data@coord$x + 200
pixelData(treatment_1_add) <- treatment_1_add_pixel_data 

treatment_2 <- set_centroid_to_true(treatment_2)
control_2 <- set_centroid_to_true(control_2)

### shift the coords of the treated sample so it doesnt overlap with the control sample image
treatment_2_add <- treatment_2
treatment_2_add_pixel_data <- pixelData(treatment_2_add)
treatment_2_add_pixel_data@coord$x <- treatment_2_add_pixel_data@coord$x + 200
pixelData(treatment_2_add) <- treatment_2_add_pixel_data 


###### Combine match runs
run1 <- Cardinal::combine(treatment_1_add, control_1)
run2 <-  Cardinal::combine(treatment_2_add, control_2)

```


## Plot Drug Data
```{r drug_data}

### Drug1
image(run1, mz=448.245, plusminus=0.01) #no features in range; re-centering m/z 448.245 to 448.260180086314
image(run1, mz=450.259, plusminus=0.01) #no features in range; re-centering m/z 450.259 to 450.281896361841

### Drug2
image(run2, mz=448.245, plusminus=0.01) #no features in range; re-centering m/z 448.245 to 448.224319843837
image(run2, mz=450.259, plusminus=0.01) #no features in range; re-centering m/z 450.259 to 450.209856151453
```


## Normalise data
```{r normalise_data}

mse_normlisation <- function(data){
  new_data <- normalize(data, method="rms")
  
  return(new_data)
}


run1_pre <- mse_normlisation(run1)
run2_pre <- mse_normlisation(run2)


mse_process <- function(data){
  new_data <- process(data)
  return(new_data)
}

run1_pre <- mse_process(run1_pre)
run2_pre <- mse_process(run2_pre)

saveRDS(run1_pre, "I:/GML001-Q1851/Andrew_C/Metabolomics/normalised_run1_pre.RDS")
saveRDS(run2_pre, "I:/GML001-Q1851/Andrew_C/Metabolomics/normalised_run2_pre.RDS")
```


## Plot Normalised Drug Data
```{r normalised_drug_data}

### Drug1
image(run1_pre, mz=448.245, plusminus=0.01, contrast.enhance="suppress", normalize.image="linear") #no features in range; re-centering m/z 448.245 to 448.260180086314
image(run1_pre, mz=450.259, plusminus=0.01, contrast.enhance="suppress", normalize.image="linear") #no features in range; re-centering m/z 450.259 to 450.281896361841

### Drug2
image(run2_pre, mz=448.245, plusminus=0.01 ) #no features in range; re-centering m/z 448.245 to 448.224319843837
image(run2_pre, mz=450.259, plusminus=0.01) #no features in range; re-centering m/z 450.259 to 450.209856151453
```



## Plot important metabolites
```{r plot_metabolites}

important_metabolomics <- read.csv(paste0(OUT_DIR, "Important_metabolites.csv"))
FMP10_detected <- read.csv(paste0(OUT_DIR, "FMP10_detected.csv"))
DHB_detected <- read.csv(paste0(OUT_DIR, "DHB_detected.csv"))


####Weird name -> rename #### 
important_metabolomics$`誰..Compound.name`[17] <- "ketoglutarate"
#############################

### Remove_duplicates ###
rename_list <- c()
for (met in important_metabolomics$`誰..Compound.name`){
  if (met %in% rename_list){
    rename_list <- c(rename_list,paste0(met,".1"))
  } else{
    rename_list <- c(rename_list,met)
  }
}

important_metabolomics$`誰..Compound.name` <- rename_list


######################################################

plot_metabolites <- function(data, data_list, run_name){
  
  image_list <- list()
  for (index in rownames(data_list)){
    index <- as.integer(index)
    
    mz <-  data_list$Monoisotopic.neutral.mass[index] 
    if(as.integer(mz) > 161){
      metabolite_name <- data_list$`誰..Compound.name`[index]
      plot <- image(data, mz = mz, plusminus=0.01,contrast.enhance="suppress", normalize.image="linear", xlab = paste0(run_name,": ",metabolite_name))
      image_list[[metabolite_name]] <- plot
    }
  }
  return(image_list)
}


run1_plots_important_metabolomics  <- plot_metabolites(run1_pre, important_metabolomics, "Run 1")
run2_plots_important_metabolomics <- plot_metabolites(run2_pre,important_metabolomics, "Run 1")


######################################################


```

## Run1 Important Metabolites Plots
```{r show_plots_run1}
run1_plots_important_metabolomics
```

## Run2 Important Metabolites Plots
```{r show_plots_run2}
run2_plots_important_metabolomics
```


## Data summary
```{r data_summary}

run1_summary <- summarizeFeatures(run1, "mean")
plot(run1_summary)

run1_summary_tic <- summarizePixels(run1, c(tic="sum"))
image(run1_summary_tic)

```


## Run Peak Binning
```{r peak_binning}
run1_summary_ref <- run1_summary %>%
  peakPick(SNR=3) %>%
  peakAlign(ref="mean",
            tolerance=0.5,
            units="mz") %>%
  peakFilter() %>%
  process()

run1_test <- run1 %>%
  normalize(method="rms") %>%
  peakBin(ref=mz(run1_summary_ref),
          tolerance=0.5,
          units="mz") %>%
  process()

```


## PCA analysis
```{r PCA_analysis}
run1_pca <- PCA(run1_test, ncomp=3)
image(run1_pca, contrast.enhance="histogram", normalize.image="linear")

plot(run1_pca, lwd=2)

```


## Segmentation of image
```{r image_segmentation}

set.seed(1)
run1_ssc <- spatialShrunkenCentroids(run1_test, method="adaptive",
                                       r=2, s=c(0,5,10,15,20,25), k=10)

summary(run1_ssc)
```


## Plot Image Segmentation
```{r plot_image_segmentation}

### CHECK WHICH S value to use -> lower = more peaks used to cluster (chose s = 15)
#image(run1_ssc, model=list(s=c(10,15,20,25)))
#plot(run1_ssc, model=list(s=20), lwd=2)

cols <- discrete.colors(6)
setup.layout(c(5,1))
plot(run1_ssc, model=list(s=15), column=1, col=cols[1], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=15), column=2, col=cols[2], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=15), column=3, col=cols[3], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=15), column=4, col=cols[4], lwd=2, layout=NULL)


setup.layout(c(2,2))
image(run1_ssc, model=list(s=15), column=1, col=cols[1], lwd=2, layout = NULL)
image(run1_ssc, model=list(s=15), column=2, col=cols[2], lwd=2, layout = NULL)
image(run1_ssc, model=list(s=15), column=3, col=cols[3], lwd=2, layout = NULL)
image(run1_ssc, model=list(s=15), column=4, col=cols[4], lwd=2, layout = NULL)


```


## Plot Segmentation Statistics
```{r segmentation_stats}

setup.layout(c(3,3))
plot(run1_ssc, model=list(s=0), values="statistic",column=1, col=cols[1], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=0), values="statistic",column=2, col=cols[2], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=0), values="statistic",column=3, col=cols[3], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=0), values="statistic",column=4, col=cols[4], lwd=2, layout=NULL)

plot(run1_ssc, model=list(s=0), values="statistic",column=5, col=cols[5], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=0), values="statistic",column=6, col=cols[6], lwd=2, layout=NULL)
plot(run1_ssc, model=list(s=0), values="statistic",column=7, col=cols[7], lwd=2, layout=NULL)


```


## Retrieving top m/z-values for Background Classes
```{r top_mz_values_background}

###BACKGROUND CLASS 1
topFeatures(run1_ssc, model=list(s=15), class==1)

###BACKGROUND CLASS 2
topFeatures(run1_ssc, model=list(s=15), class==4)

```


## Retrieving top m/z-values for Tissue Classes
```{r top_mz_values}

###Tissue CLASS 1
topFeatures(run1_ssc, model=list(s=15), class==2)

###Tissue CLASS 2
topFeatures(run1_ssc, model=list(s=15), class==3)

```

## Subset to remove background
```{r remove_background}

run1_finalised <- spatialShrunkenCentroids(run1_test, method="adaptive",
                                       r=2, s=c(15), k=10)

test_run <- run1_finalised
pixelData(test_run)@listData$cluster <- resultData(run1_finalised)[[1]]$class

keep_clusters <- c()
for (cluster in pixelData(test_run)@listData$cluster){
  if (cluster == 2 | cluster == 3){
    keep_bool <- TRUE
  } else{
    keep_bool <- FALSE
  }
  keep_clusters <- c(keep_clusters, keep_bool)
}

pixelData(run1)@listData$tissue <- keep_clusters

#image(run1_test, mz = 450, subset = tissue)

##subset

run1_subset <- run1_pre[,pixels(run1_pre, subset = tissue)]


####Put together a collective plot ####
image(run1_ssc, model=list(s=15), column=1, col=cols[1], lwd=2, layout = NULL)
plot1 <- recordPlot()
image(run1_ssc, model=list(s=15), column=2, col=cols[2], lwd=2, layout = NULL)
plot2 <- recordPlot()
image(run1_ssc, model=list(s=15), column=3, col=cols[3], lwd=2, layout = NULL)
plot3 <- recordPlot()
image(run1_ssc, model=list(s=15), column=4, col=cols[4], lwd=2, layout = NULL)
plot4 <- recordPlot()
image(run1_subset, mz=450.259, plusminus=0.01)
plot5 <- recordPlot()
image(run1_subset, mz=448.245, plusminus=0.01)
plot6 <- recordPlot()

plots <- plot_grid(plot1,
          plot2, 
          plot3,
          plot4,
          plot5, 
          plot6,
          ncol = 2, scale = 0.8)

pdf(paste(OUT_DIR,"run1_segmentation_results.pdf"))
plots
dev.off()

```


## Data summary pre- vs post- background removal
```{r compare_data_summary}

##Pre
plot(run1_summary)
plot1 <- recordPlot()

##Post
run1_post_summary <- summarizeFeatures(run1_subset, "mean")
plot(run1_post_summary)
plot2 <- recordPlot()


##Pre
image(run1_summary_tic)
plot3 <- recordPlot()

##Post
run1_post_summary_tic <- summarizePixels(run1_subset, c(tic="sum"))
image(run1_post_summary_tic)
plot4 <- recordPlot()


plots <- plot_grid(plot1,plot2,plot3,plot4, ncol = 2, scale = 0.8)

```




## Tissue Peak Binning and PCA with background removed
```{r processesing_background_removed_image}

#Run peak binning
run1__post_summary_ref <- run1_post_summary %>%
  peakPick(SNR=3) %>%
  peakAlign(ref="mean",
            tolerance=0.5,
            units="mz") %>%
  peakFilter() %>%
  process()

run1_clean <- run1_subset %>%
  normalize(method="rms") %>%
  peakBin(ref=mz(run1__post_summary_ref),
          tolerance=0.5,
          units="mz") %>%
  process()


## PCA analysis
run1_clean_pca <- PCA(run1_clean, ncomp=3)

image(run1_clean_pca, contrast.enhance="histogram", normalize.image="linear")
plot(run1_clean_pca, lwd=2)
```


## Run clustering on processed data
```{r clustering_processed_data}
set.seed(1)
run1_clean_ssc <- spatialShrunkenCentroids(run1_clean, method="adaptive",
                                       r=2, s=c(0,5,10,15,20,25), k=10)

summary(run1_clean_ssc)

## Plot Image Segmentation

image(run1_clean_ssc, model=list(s=c(10,15,20,25)))
plot(run1_clean_ssc, model=list(s=20), lwd=2)

topFeatures(run1_clean_ssc, model=list(s=0))


image(run1_clean, mz=450.259, plusminus=0.01)
plot1 <- recordPlot()
image(run1_clean, mz=448.245, plusminus=0.01)
plot2 <- recordPlot()

plots <- plot_grid(plot1,
          plot2,ncol = 2, scale = 0.8)

```


























